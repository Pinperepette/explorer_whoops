<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARRHESEPSTEIN &mdash; Entity Knowledge Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #08080d; --surface: #10101a; --surface2: #181828;
            --border: #252540; --accent: #e63946; --accent2: #f4a261;
            --accent3: #2a9d8f; --text: #ddd; --dim: #777; --gold: #f1c40f;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); min-width:0; overflow-x:hidden; }

        .topnav {
            background:#060609; border-bottom:1px solid var(--border);
            padding:8px 20px; display:flex; gap:18px; align-items:center; font-size:.85em;
        }
        .topnav a { color:var(--dim); text-decoration:none; transition:color .2s; }
        .topnav a:hover { color:var(--accent); }
        .topnav a.active { color:#e63946; font-weight:bold; border-bottom:2px solid #e63946; padding-bottom:2px; }

        .header {
            background: linear-gradient(135deg,#120808,#080812);
            border-bottom: 3px solid var(--accent);
            padding: 35px 40px 25px; text-align: center;
        }
        .header .brand { font-size:.85em; letter-spacing:6px; color:var(--dim); text-transform:uppercase; }
        .header h1 { font-size:2.6em; color:var(--accent); letter-spacing:3px; margin:4px 0; }
        .header .term-label {
            display:inline-block; margin-top:10px; padding:6px 24px;
            background:rgba(230,57,70,.15); border:1px solid var(--accent);
            border-radius:20px; font-size:1.3em; color:#ff6b6b; font-weight:bold; letter-spacing:2px;
        }
        .header .subtitle { color:var(--dim); margin-top:8px; font-size:.95em; font-style:italic; }
        .stats-bar { display:flex; justify-content:center; gap:30px; margin-top:20px; flex-wrap:wrap; }
        .stat { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 22px; text-align:center; }
        .stat .n { font-size:1.9em; font-weight:bold; color:var(--accent2); }
        .stat .l { font-size:.8em; color:var(--dim); }

        .container { max-width:1650px; margin:0 auto; padding:20px 25px; width:100%; min-width:0; }

        .section {
            background:var(--surface); border:1px solid var(--border);
            border-radius:10px; padding:22px; margin-bottom:22px; min-width:0; overflow:hidden;
        }
        .section h2 { color:var(--accent2); font-size:1.3em; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:8px; }

        .analysis-header {
            background: linear-gradient(135deg, var(--surface2), var(--surface));
            border:2px solid var(--accent); border-radius:12px;
            padding:20px 24px; margin-bottom:22px; text-align:center;
        }
        .analysis-header h2 { color:var(--accent); font-size:1.6em; border:none; margin-bottom:6px; padding-bottom:0; }
        .analysis-header .desc { color:var(--dim); font-size:.9em; }

        /* GRAPH */
        #graph-container {
            position:relative; width:100%; height:620px;
            background:var(--surface); border:1px solid var(--border); border-radius:10px;
            overflow:hidden;
        }
        #graph-container svg { width:100%; height:100%; }

        /* TOOLTIP */
        .graph-tooltip {
            position:absolute; pointer-events:none; opacity:0;
            background:rgba(16,16,26,.96); border:1px solid var(--accent);
            border-radius:8px; padding:12px 16px; font-size:.82em;
            color:var(--text); max-width:280px; z-index:100;
            box-shadow:0 4px 20px rgba(0,0,0,.5);
            transition:opacity .15s;
        }
        @media(max-width:600px) {
            .graph-tooltip { display:none !important; }
        }
        .graph-tooltip .tt-name { font-weight:bold; color:var(--accent); font-size:1.1em; margin-bottom:4px; }
        .graph-tooltip .tt-row { margin:2px 0; }
        .graph-tooltip .tt-label { color:var(--dim); }

        /* FILTERS */
        .filter-panel {
            display:grid; grid-template-columns:1fr 2fr 1fr 1fr; gap:16px;
            align-items:end; margin-bottom:16px; padding:16px 20px;
            background:var(--surface); border:1px solid var(--border); border-radius:10px;
        }
        .filter-group label { display:block; font-size:.78em; color:var(--dim); margin-bottom:5px; text-transform:uppercase; letter-spacing:1px; }
        .filter-group input[type="text"],
        .filter-group select {
            width:100%; padding:8px 12px; background:var(--surface2); border:1px solid var(--border);
            border-radius:6px; color:var(--text); font-size:.88em; outline:none; transition:border-color .2s;
        }
        .filter-group input[type="text"]:focus,
        .filter-group select:focus { border-color:var(--accent); }
        .filter-group input[type="range"] { width:100%; accent-color:var(--accent); }
        .type-filters { display:flex; flex-wrap:wrap; gap:8px; }
        .type-cb {
            display:flex; align-items:center; gap:4px; padding:4px 10px;
            background:var(--surface2); border:1px solid var(--border); border-radius:14px;
            font-size:.78em; cursor:pointer; transition:all .2s; user-select:none;
        }
        .type-cb:hover { border-color:var(--accent); }
        .type-cb input { accent-color:var(--accent); cursor:pointer; }
        .type-cb.checked { border-color:var(--accent); background:rgba(230,57,70,.1); }

        .color-toggle {
            display:flex; gap:8px; align-items:center;
        }
        .toggle-btn {
            padding:6px 14px; border:1px solid var(--border); border-radius:6px;
            background:var(--surface2); color:var(--dim); font-size:.8em; cursor:pointer;
            transition:all .2s;
        }
        .toggle-btn.active { background:rgba(230,57,70,.15); border-color:var(--accent); color:var(--accent); }
        .toggle-btn:hover { border-color:var(--accent); color:var(--text); }

        /* LEGEND */
        .graph-legend {
            position:absolute; top:12px; left:12px; z-index:10;
            background:rgba(16,16,26,.92); border:1px solid var(--border);
            border-radius:8px; padding:10px 14px; font-size:.75em;
        }
        .legend-item { display:flex; align-items:center; gap:6px; margin:3px 0; }
        .legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

        /* GRAPH STATS OVERLAY */
        .graph-stats-overlay {
            position:absolute; bottom:12px; right:12px; z-index:10;
            background:rgba(16,16,26,.92); border:1px solid var(--border);
            border-radius:8px; padding:8px 12px; font-size:.72em; color:var(--dim);
        }

        /* DETAIL PANEL */
        .detail-panel {
            position:absolute; top:12px; right:12px; z-index:20;
            width:320px; max-height:580px; overflow-y:auto;
            background:rgba(16,16,26,.96); border:1px solid var(--accent);
            border-radius:10px; padding:18px; display:none;
            box-shadow:0 8px 32px rgba(0,0,0,.6);
        }
        .detail-panel.active { display:block; }
        .detail-backdrop {
            display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
            z-index:999;
        }
        .detail-backdrop.active { display:block; }
        @media(min-width:901px) { .detail-backdrop { display:none !important; } }
        .detail-panel .dp-close {
            position:absolute; top:8px; right:12px; background:none; border:none;
            color:var(--dim); font-size:1.4em; cursor:pointer; line-height:1;
        }
        .detail-panel .dp-close:hover { color:var(--accent); }
        .detail-panel .dp-name { font-size:1.3em; font-weight:bold; color:var(--accent); margin-bottom:4px; }
        .detail-panel .dp-type {
            display:inline-block; padding:2px 10px; border-radius:12px;
            font-size:.75em; font-weight:bold; margin-bottom:10px;
        }
        .dp-stats { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:12px 0; }
        .dp-stat {
            background:var(--surface2); border:1px solid var(--border);
            border-radius:6px; padding:8px 10px; text-align:center;
        }
        .dp-stat .dp-val { font-size:1.2em; font-weight:bold; color:var(--accent2); }
        .dp-stat .dp-lbl { font-size:.7em; color:var(--dim); text-transform:uppercase; }
        .dp-section-title { font-size:.85em; color:var(--accent2); margin:14px 0 6px; font-weight:bold; border-bottom:1px solid var(--border); padding-bottom:4px; }
        .dp-connection {
            display:flex; justify-content:space-between; align-items:center;
            padding:4px 8px; margin:2px 0; border-radius:4px;
            font-size:.8em; background:var(--surface2); border:1px solid transparent;
            cursor:pointer; transition:all .15s;
        }
        .dp-connection:hover { border-color:var(--accent); background:rgba(230,57,70,.08); }
        .dp-connection .conn-name { color:var(--text); }
        .dp-connection .conn-weight { color:var(--accent2); font-weight:bold; font-size:.85em; }
        .dp-dataset {
            display:flex; justify-content:space-between; padding:3px 8px;
            font-size:.8em; background:var(--surface2); border-radius:4px; margin:2px 0;
        }
        .dp-dataset .ds-name { color:var(--accent3); }
        .dp-dataset .ds-count { color:var(--accent2); font-weight:bold; }

        /* CHARTS */
        .chart-container { position:relative; width:100%; max-width:800px; margin:16px auto; }
        .chart-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:16px 0; }

        /* COMMUNITY CARDS */
        .comm-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:16px; margin-top:16px; }
        .comm-card {
            background:var(--surface2); border:1px solid var(--border); border-radius:10px;
            padding:16px 18px; transition:border-color .2s;
        }
        .comm-card:hover { border-color:var(--accent); }
        .comm-card .cc-header {
            display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
        }
        .comm-card .cc-id { font-size:1.2em; font-weight:bold; color:var(--accent); }
        .comm-card .cc-count {
            padding:3px 12px; background:rgba(244,162,97,.12); border:1px solid var(--accent2);
            border-radius:12px; font-size:.78em; color:var(--accent2);
        }
        .comm-card .cc-entities { margin:8px 0; }
        .comm-card .cc-entity {
            display:inline-block; margin:2px 4px 2px 0; padding:3px 10px;
            background:rgba(230,57,70,.08); border:1px solid var(--border);
            border-radius:14px; font-size:.75em; color:var(--text); transition:all .2s;
        }
        .comm-card .cc-entity:hover { border-color:var(--accent); }
        .comm-card .cc-entity .ce-freq { color:var(--accent2); margin-left:4px; }
        .cc-types { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
        .cc-type-badge {
            padding:2px 8px; border-radius:10px; font-size:.7em; font-weight:bold;
        }

        /* RESPONSIVE */
        @media(max-width:1100px) {
            .filter-panel { grid-template-columns:1fr 1fr; }
        }
        @media(max-width:900px) {
            .topnav { padding:8px 10px; gap:10px; font-size:.78em; overflow-x:auto; flex-wrap:nowrap; white-space:nowrap; -webkit-overflow-scrolling:touch; }
            .topnav::-webkit-scrollbar { display:none; }
            .header h1 { font-size:1.8em; }
            .header .term-label { font-size:1em; }
            .stats-bar { gap:10px; }
            .stat { padding:8px 14px; }
            .stat .n { font-size:1.3em; }
            .stat .l { font-size:.7em; }
            .container { padding:12px 10px; }
            .chart-row { grid-template-columns:1fr; }
            .filter-panel { grid-template-columns:1fr; gap:12px; padding:12px 14px; }
            .detail-panel {
                position:fixed; top:auto; bottom:0; left:0; right:0;
                width:100% !important; max-width:100%; max-height:55vh;
                border-radius:16px 16px 0 0; z-index:1000;
            }
            .comm-grid { grid-template-columns:1fr; }
            .graph-legend { font-size:.65em; padding:6px 8px; max-width:120px; }
            .graph-stats-overlay { font-size:.62em; padding:5px 8px; }
            #graph-container { height:55vh; }
        }
        @media(max-width:500px) {
            .topnav { padding:6px 8px; gap:12px; font-size:.72em; }
            .topnav a { flex-shrink:0; }
            .header h1 { font-size:1.3em; letter-spacing:1px; }
            .header .brand { font-size:.7em; letter-spacing:3px; }
            .header { padding:18px 12px 14px; }
            .header .term-label { font-size:.8em; padding:4px 14px; }
            .header .subtitle { font-size:.78em; }
            .stats-bar { gap:6px; }
            .stat { padding:6px 10px; min-width:0; }
            .stat .n { font-size:1.1em; }
            .stat .l { font-size:.62em; }
            .section { padding:12px 10px; }
            .section h2 { font-size:1.1em; }
            .analysis-header { padding:12px 14px; }
            .analysis-header h2 { font-size:1.15em; }
            .analysis-header .desc { font-size:.78em; }
            #graph-container { height:50vh; min-height:300px; }
            .detail-panel { max-height:50vh; }
            .detail-panel .dp-name { font-size:1.1em; }
            .dp-stats { grid-template-columns:1fr 1fr; gap:6px; }
            .dp-stat { padding:6px 8px; }
            .dp-stat .dp-val { font-size:1em; }
            .graph-legend { top:6px; left:6px; padding:4px 6px; font-size:.6em; max-width:100px; }
            .legend-dot { width:7px; height:7px; }
            .graph-stats-overlay { bottom:6px; right:6px; font-size:.58em; }
            .chart-container { max-width:100%; }
            .type-filters { gap:5px; }
            .type-cb { padding:3px 8px; font-size:.72em; }
            .comm-card { padding:12px 14px; }
            .comm-card .cc-entity { font-size:.68em; padding:2px 7px; }
            .filter-group label { font-size:.7em; }
            .filter-group input[type="text"],
            .filter-group select { font-size:.82em; padding:7px 10px; }
            .color-toggle { gap:5px; }
            .toggle-btn { padding:5px 10px; font-size:.72em; }
        }
        @media(max-width:360px) {
            .header h1 { font-size:1.1em; }
            .stats-bar { gap:4px; }
            .stat { padding:5px 7px; }
            .stat .n { font-size:.95em; }
            #graph-container { height:45vh; min-height:260px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:var(--bg); }
        ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:var(--dim); }
    </style>
</head>
<body>

<nav class="topnav">
    <a href="index.html">Whoops</a>
    <a href="snow-white.html">Snow White</a>
    <a href="code-language.html">Code Language</a>
    <a href="bridging-analysis.html">Bridging</a>
    <a href="network-analysis.html">Network</a>
    <a href="discovery-analysis.html">Discovery</a>
    <a href="entity-graph.html" class="active">Entity Graph</a>
</nav>

<div class="header">
    <div class="brand">PARRHESEPSTEIN &mdash; Analisi Forense Documentale</div>
    <h1>ENTITY KNOWLEDGE GRAPH</h1>
    <div class="term-label">NER &bull; Co-occurrence &bull; Community Detection</div>
    <div class="subtitle">Grafo interattivo delle entit&agrave; estratte dai documenti declassificati &mdash; Named Entity Recognition e analisi di rete</div>
    <div class="stats-bar" id="stats-bar">
        <div class="stat"><div class="n" id="st-total">--</div><div class="l">Entit&agrave; Uniche</div></div>
        <div class="stat"><div class="n" id="st-nodes">--</div><div class="l">Nodi nel Grafo</div></div>
        <div class="stat"><div class="n" id="st-edges">--</div><div class="l">Archi nel Grafo</div></div>
        <div class="stat"><div class="n" id="st-comm">--</div><div class="l">Comunit&agrave;</div></div>
        <div class="stat"><div class="n" id="st-docs">--</div><div class="l">Documenti Analizzati</div></div>
    </div>
</div>

<div class="container">

<!-- ====== FILTER PANEL ====== -->
<div class="filter-panel">
    <div class="filter-group">
        <label>Cerca Entit&agrave;</label>
        <input type="text" id="search-input" placeholder="Digita un nome...">
    </div>
    <div class="filter-group">
        <label>Filtra per Tipo</label>
        <div class="type-filters" id="type-filters"></div>
    </div>
    <div class="filter-group">
        <label>Comunit&agrave;</label>
        <select id="community-filter">
            <option value="all">Tutte le comunit&agrave;</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Peso minimo archi: <span id="weight-val">2</span></label>
        <input type="range" id="weight-slider" min="1" max="30" value="2">
        <div style="margin-top:6px;">
            <label style="margin-bottom:0;">Colore nodi</label>
            <div class="color-toggle">
                <button class="toggle-btn active" id="btn-color-type" onclick="setColorMode('type')">Tipo</button>
                <button class="toggle-btn" id="btn-color-comm" onclick="setColorMode('community')">Comunit&agrave;</button>
            </div>
        </div>
    </div>
</div>

<!-- ====== GRAPH ====== -->
<div id="graph-container">
    <svg id="graph-svg"></svg>
    <div class="graph-legend" id="graph-legend"></div>
    <div class="graph-stats-overlay" id="graph-overlay"></div>
    <div class="graph-tooltip" id="graph-tooltip"></div>

    <!-- DETAIL PANEL -->
    <div class="detail-backdrop" id="detail-backdrop" onclick="closeDetail()"></div>
    <div class="detail-panel" id="detail-panel">
        <button class="dp-close" onclick="closeDetail()">&times;</button>
        <div id="dp-content"></div>
    </div>
</div>

<!-- ====== STATISTICS ====== -->
<div class="analysis-header" style="margin-top:22px;">
    <h2>STATISTICHE CENTRALIT&Agrave;</h2>
    <div class="desc">Top entit&agrave; per Frequenza, PageRank e Betweenness Centrality</div>
</div>

<div class="chart-row">
    <div class="section">
        <h2>Top 15 per Frequenza</h2>
        <div class="chart-container"><canvas id="chart-freq"></canvas></div>
    </div>
    <div class="section">
        <h2>Distribuzione Tipi Entit&agrave;</h2>
        <div class="chart-container" style="max-width:400px;"><canvas id="chart-types"></canvas></div>
    </div>
</div>
<div class="chart-row">
    <div class="section">
        <h2>Top 15 per PageRank</h2>
        <div class="chart-container"><canvas id="chart-pr"></canvas></div>
    </div>
    <div class="section">
        <h2>Top 15 per Betweenness Centrality</h2>
        <div class="chart-container"><canvas id="chart-btw"></canvas></div>
    </div>
</div>

<!-- ====== COMMUNITIES ====== -->
<div class="analysis-header">
    <h2>ANALISI COMUNIT&Agrave;</h2>
    <div class="desc">Raggruppamenti individuati tramite algoritmo di community detection sul grafo di co-occorrenza</div>
</div>

<div class="section">
    <h2>Comunit&agrave; Rilevate</h2>
    <div class="comm-grid" id="comm-grid"></div>
</div>

</div><!-- /container -->

<script>
/* ================================================================
   PARRHESEPSTEIN Entity Knowledge Graph
   Interactive D3.js force-directed graph + Chart.js statistics
   ================================================================ */

const TYPE_COLORS = {
    PERSON: '#e63946',
    ORG:    '#f4a261',
    GPE:    '#2a9d8f',
    LOC:    '#457b9d',
    NORP:   '#9b59b6',
    FAC:    '#95a5a6'
};

const COMMUNITY_COLORS = [
    '#e63946','#f4a261','#2a9d8f','#457b9d','#9b59b6',
    '#e74c3c','#1abc9c','#f39c12','#3498db','#e67e22',
    '#8e44ad','#27ae60','#d35400','#2980b9','#c0392b'
];

let DATA = null;
let simulation = null;
let isMobile = window.innerWidth < 600;
let colorMode = 'type';
let selectedNode = null;
let activeTypes = new Set();
let currentCommunity = 'all';
let minWeight = 2;
let searchTerm = '';

// ===== LOAD DATA =====
fetch('entity_graph_data.json')
    .then(r => r.json())
    .then(data => {
        DATA = data;
        initPage();
    })
    .catch(err => {
        document.getElementById('graph-container').innerHTML =
            '<div style="padding:40px;text-align:center;color:var(--accent);">Errore nel caricamento di entity_graph_data.json: ' + err.message + '</div>';
    });

function initPage() {
    populateStats();
    populateFilters();
    buildGraph();
    buildCharts();
    buildCommunities();
}

// ===== STATS BAR =====
function populateStats() {
    const s = DATA.stats;
    document.getElementById('st-total').textContent = s.unique_canonical.toLocaleString('it-IT');
    document.getElementById('st-nodes').textContent = s.nodes_in_graph.toLocaleString('it-IT');
    document.getElementById('st-edges').textContent = s.edges_in_graph.toLocaleString('it-IT');
    document.getElementById('st-comm').textContent = s.communities;
    document.getElementById('st-docs').textContent = s.total_documents.toLocaleString('it-IT');
}

// ===== FILTERS =====
function populateFilters() {
    const types = Object.keys(TYPE_COLORS);
    const container = document.getElementById('type-filters');
    types.forEach(t => {
        activeTypes.add(t);
        const div = document.createElement('div');
        div.className = 'type-cb checked';
        div.innerHTML = `<input type="checkbox" checked data-type="${t}"><span style="color:${TYPE_COLORS[t]}">${t}</span>`;
        div.querySelector('input').addEventListener('change', function() {
            if (this.checked) { activeTypes.add(t); div.classList.add('checked'); }
            else { activeTypes.delete(t); div.classList.remove('checked'); }
            updateGraph();
        });
        container.appendChild(div);
    });

    // Community filter
    const sel = document.getElementById('community-filter');
    const commKeys = Object.keys(DATA.communities).sort((a,b) => +a - +b);
    commKeys.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = `Comunit\u00e0 ${k} (${DATA.communities[k].count} entit\u00e0)`;
        sel.appendChild(opt);
    });
    sel.addEventListener('change', function() {
        currentCommunity = this.value;
        updateGraph();
    });

    // Weight slider
    const slider = document.getElementById('weight-slider');
    const valSpan = document.getElementById('weight-val');
    slider.addEventListener('input', function() {
        minWeight = +this.value;
        valSpan.textContent = minWeight;
        updateGraph();
    });

    // Search
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchTerm = this.value.trim().toLowerCase();
            updateGraph();
        }, 200);
    });
}

function setColorMode(mode) {
    colorMode = mode;
    document.getElementById('btn-color-type').classList.toggle('active', mode === 'type');
    document.getElementById('btn-color-comm').classList.toggle('active', mode === 'community');
    updateLegend();
    updateNodeColors();
}

// ===== D3 GRAPH =====
let svg, gLinks, gNodes, gLabels, zoom;
let nodesData = [], linksData = [];
let nodeElements, linkElements, labelElements;
let nodeMap = {};

function buildGraph() {
    const container = document.getElementById('graph-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    svg = d3.select('#graph-svg');
    svg.selectAll('*').remove();

    // Defs for glow
    const defs = svg.append('defs');
    const filter = defs.append('filter').attr('id','glow');
    filter.append('feGaussianBlur').attr('stdDeviation','3').attr('result','coloredBlur');
    const merge = filter.append('feMerge');
    merge.append('feMergeNode').attr('in','coloredBlur');
    merge.append('feMergeNode').attr('in','SourceGraphic');

    // Arrow marker
    defs.append('marker')
        .attr('id','arrow')
        .attr('viewBox','0 -5 10 10')
        .attr('refX',20).attr('refY',0)
        .attr('markerWidth',6).attr('markerHeight',6)
        .attr('orient','auto')
        .append('path').attr('d','M0,-5L10,0L0,5').attr('fill','rgba(255,255,255,.15)');

    const g = svg.append('g').attr('id','graph-g');

    gLinks = g.append('g').attr('class','links');
    gNodes = g.append('g').attr('class','nodes');
    gLabels = g.append('g').attr('class','labels');

    // Zoom
    zoom = d3.zoom()
        .scaleExtent([0.1, 8])
        .on('zoom', (event) => g.attr('transform', event.transform));
    svg.call(zoom);

    // Build node map
    DATA.nodes.forEach(n => { nodeMap[n.id] = n; });

    // Prepare data
    prepareGraphData();

    // Adapt forces for screen size
    isMobile = width < 600;
    const chargeStrength = isMobile ? (d => -20 - d.frequency * 1.5) : (d => -40 - d.frequency * 3);
    const linkDist = isMobile ? (d => 50 / Math.log(d.weight + 1)) : (d => 80 / Math.log(d.weight + 1));

    // Simulation
    simulation = d3.forceSimulation(nodesData)
        .force('link', d3.forceLink(linksData).id(d => d.id).distance(linkDist))
        .force('charge', d3.forceManyBody().strength(chargeStrength))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => nodeRadius(d) + (isMobile ? 1 : 2)))
        .force('x', d3.forceX(width / 2).strength(isMobile ? 0.06 : 0.03))
        .force('y', d3.forceY(height / 2).strength(isMobile ? 0.06 : 0.03))
        .alphaDecay(0.02)
        .on('tick', ticked);

    renderGraph();
    updateLegend();
    updateOverlay();
}

function prepareGraphData() {
    nodesData = DATA.nodes.filter(n => {
        if (!activeTypes.has(n.type)) return false;
        if (currentCommunity !== 'all' && n.community !== +currentCommunity) return false;
        return true;
    }).map(n => ({...n}));

    const nodeIds = new Set(nodesData.map(n => n.id));

    linksData = DATA.edges.filter(e => {
        return e.weight >= minWeight && nodeIds.has(e.source) && nodeIds.has(e.target);
    }).map(e => ({...e}));
}

function nodeRadius(d) {
    return 3 + Math.log(d.frequency + 1) * 4;
}

function nodeColor(d) {
    if (colorMode === 'type') return TYPE_COLORS[d.type] || '#666';
    return COMMUNITY_COLORS[d.community % COMMUNITY_COLORS.length];
}

function renderGraph() {
    // Links
    linkElements = gLinks.selectAll('line').data(linksData, d => d.source.id ? d.source.id+'-'+d.target.id : d.source+'-'+d.target);
    linkElements.exit().remove();
    linkElements = linkElements.enter()
        .append('line')
        .attr('stroke', 'rgba(255,255,255,.08)')
        .attr('stroke-width', d => Math.max(0.3, Math.log(d.weight + 1) * 0.6))
        .merge(linkElements);

    // Nodes
    nodeElements = gNodes.selectAll('circle').data(nodesData, d => d.id);
    nodeElements.exit().remove();
    nodeElements = nodeElements.enter()
        .append('circle')
        .attr('r', d => nodeRadius(d))
        .attr('fill', d => nodeColor(d))
        .attr('stroke', 'rgba(255,255,255,.15)')
        .attr('stroke-width', 0.5)
        .attr('cursor', 'pointer')
        .on('mouseover', handleMouseOver)
        .on('mouseout', handleMouseOut)
        .on('click', handleClick)
        .call(d3.drag()
            .on('start', dragStart)
            .on('drag', dragging)
            .on('end', dragEnd))
        .merge(nodeElements);

    // Labels - only show for high-frequency nodes (fewer on mobile)
    const labelQuantile = isMobile ? 0.88 : 0.7;
    const freqThreshold = Math.max(6, d3.quantile(nodesData.map(n => n.frequency).sort(d3.ascending), labelQuantile));
    const labelData = nodesData.filter(n => n.frequency >= freqThreshold);
    const maxLabelLen = isMobile ? 14 : 20;
    const maxFontSize = isMobile ? 9 : 12;
    const baseFontSize = isMobile ? 5 : 7;

    labelElements = gLabels.selectAll('text').data(labelData, d => d.id);
    labelElements.exit().remove();
    labelElements = labelElements.enter()
        .append('text')
        .attr('font-size', d => Math.min(maxFontSize, baseFontSize + Math.log(d.frequency) * 1.2) + 'px')
        .attr('fill', 'rgba(255,255,255,.85)')
        .attr('text-anchor', 'middle')
        .attr('dy', d => -nodeRadius(d) - 3)
        .attr('pointer-events', 'none')
        .attr('font-weight', '600')
        .attr('paint-order', 'stroke')
        .attr('stroke', 'rgba(8,8,13,.8)')
        .attr('stroke-width', '2.5px')
        .text(d => d.id.length > maxLabelLen ? d.id.substring(0, maxLabelLen - 2) + '..' : d.id)
        .merge(labelElements);

    // Apply search highlighting
    if (searchTerm) {
        nodeElements
            .attr('opacity', d => d.id.toLowerCase().includes(searchTerm) ? 1 : 0.15)
            .attr('filter', d => d.id.toLowerCase().includes(searchTerm) ? 'url(#glow)' : null);
        linkElements.attr('opacity', d => {
            const sid = typeof d.source === 'object' ? d.source.id : d.source;
            const tid = typeof d.target === 'object' ? d.target.id : d.target;
            return (sid.toLowerCase().includes(searchTerm) || tid.toLowerCase().includes(searchTerm)) ? 0.4 : 0.03;
        });
        labelElements.attr('opacity', d => d.id.toLowerCase().includes(searchTerm) ? 1 : 0.1);
    } else {
        nodeElements.attr('opacity', 1).attr('filter', null);
        linkElements.attr('opacity', 1);
        labelElements.attr('opacity', 1);
    }
}

function updateGraph() {
    prepareGraphData();

    simulation.nodes(nodesData);
    simulation.force('link').links(linksData);
    simulation.alpha(0.6).restart();

    gLinks.selectAll('line').remove();
    gNodes.selectAll('circle').remove();
    gLabels.selectAll('text').remove();

    renderGraph();
    updateOverlay();
}

function updateNodeColors() {
    if (nodeElements) {
        nodeElements.attr('fill', d => nodeColor(d));
    }
}

function updateLegend() {
    const legend = document.getElementById('graph-legend');
    let html = '';
    if (colorMode === 'type') {
        Object.entries(TYPE_COLORS).forEach(([t, c]) => {
            html += `<div class="legend-item"><div class="legend-dot" style="background:${c}"></div>${t}</div>`;
        });
    } else {
        const commKeys = Object.keys(DATA.communities).sort((a,b) => +a - +b);
        commKeys.forEach(k => {
            html += `<div class="legend-item"><div class="legend-dot" style="background:${COMMUNITY_COLORS[+k % COMMUNITY_COLORS.length]}"></div>Comunit\u00e0 ${k}</div>`;
        });
    }
    legend.innerHTML = html;
}

function updateOverlay() {
    const el = document.getElementById('graph-overlay');
    el.innerHTML = `Nodi: ${nodesData.length} | Archi: ${linksData.length} | Peso min: ${minWeight}`;
}

function ticked() {
    linkElements
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
    nodeElements
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);
    labelElements
        .attr('x', d => d.x)
        .attr('y', d => d.y - nodeRadius(d) - 3);
}

// ===== INTERACTIONS =====
function handleMouseOver(event, d) {
    const tooltip = document.getElementById('graph-tooltip');
    tooltip.innerHTML = `
        <div class="tt-name">${d.id}</div>
        <div class="tt-row"><span class="tt-label">Tipo:</span> <span style="color:${TYPE_COLORS[d.type]}">${d.type}</span></div>
        <div class="tt-row"><span class="tt-label">Frequenza:</span> ${d.frequency}</div>
        <div class="tt-row"><span class="tt-label">Comunit&agrave;:</span> ${d.community}</div>
        <div class="tt-row"><span class="tt-label">Grado:</span> ${d.degree}</div>
        <div class="tt-row"><span class="tt-label">PageRank:</span> ${d.pagerank.toFixed(6)}</div>
    `;
    tooltip.style.opacity = 1;
    tooltip.style.left = (event.offsetX + 15) + 'px';
    tooltip.style.top = (event.offsetY - 10) + 'px';

    // Highlight connected
    if (!selectedNode) {
        const connected = getConnectedIds(d.id);
        nodeElements.attr('opacity', n => n.id === d.id || connected.has(n.id) ? 1 : 0.12);
        linkElements.attr('opacity', l => {
            const sid = typeof l.source === 'object' ? l.source.id : l.source;
            const tid = typeof l.target === 'object' ? l.target.id : l.target;
            return (sid === d.id || tid === d.id) ? 0.6 : 0.02;
        }).attr('stroke', l => {
            const sid = typeof l.source === 'object' ? l.source.id : l.source;
            const tid = typeof l.target === 'object' ? l.target.id : l.target;
            return (sid === d.id || tid === d.id) ? 'rgba(230,57,70,.5)' : 'rgba(255,255,255,.08)';
        });
        labelElements.attr('opacity', n => n.id === d.id || connected.has(n.id) ? 1 : 0.08);
    }

    d3.select(event.currentTarget)
        .attr('filter', 'url(#glow)')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2);
}

function handleMouseOut(event, d) {
    document.getElementById('graph-tooltip').style.opacity = 0;

    if (!selectedNode) {
        if (searchTerm) {
            nodeElements
                .attr('opacity', n => n.id.toLowerCase().includes(searchTerm) ? 1 : 0.15)
                .attr('filter', n => n.id.toLowerCase().includes(searchTerm) ? 'url(#glow)' : null);
            linkElements.attr('opacity', 1).attr('stroke', 'rgba(255,255,255,.08)');
            labelElements.attr('opacity', n => n.id.toLowerCase().includes(searchTerm) ? 1 : 0.1);
        } else {
            nodeElements.attr('opacity', 1);
            linkElements.attr('opacity', 1).attr('stroke', 'rgba(255,255,255,.08)');
            labelElements.attr('opacity', 1);
        }
    }

    d3.select(event.currentTarget)
        .attr('filter', null)
        .attr('stroke', 'rgba(255,255,255,.15)')
        .attr('stroke-width', 0.5);
}

function handleClick(event, d) {
    event.stopPropagation();
    selectedNode = d;
    showDetailPanel(d);
    highlightNode(d);
}

function highlightNode(d) {
    const connected = getConnectedIds(d.id);
    nodeElements
        .attr('opacity', n => n.id === d.id || connected.has(n.id) ? 1 : 0.08)
        .attr('filter', n => n.id === d.id ? 'url(#glow)' : null)
        .attr('stroke', n => n.id === d.id ? '#fff' : 'rgba(255,255,255,.15)')
        .attr('stroke-width', n => n.id === d.id ? 2.5 : 0.5);
    linkElements
        .attr('opacity', l => {
            const sid = typeof l.source === 'object' ? l.source.id : l.source;
            const tid = typeof l.target === 'object' ? l.target.id : l.target;
            return (sid === d.id || tid === d.id) ? 0.7 : 0.015;
        })
        .attr('stroke', l => {
            const sid = typeof l.source === 'object' ? l.source.id : l.source;
            const tid = typeof l.target === 'object' ? l.target.id : l.target;
            return (sid === d.id || tid === d.id) ? 'rgba(230,57,70,.6)' : 'rgba(255,255,255,.08)';
        })
        .attr('stroke-width', l => {
            const sid = typeof l.source === 'object' ? l.source.id : l.source;
            const tid = typeof l.target === 'object' ? l.target.id : l.target;
            return (sid === d.id || tid === d.id)
                ? Math.max(1.5, Math.log(l.weight + 1) * 1.2)
                : Math.max(0.3, Math.log(l.weight + 1) * 0.6);
        });
    labelElements.attr('opacity', n => n.id === d.id || connected.has(n.id) ? 1 : 0.05);
}

function getConnectedIds(nodeId) {
    const connected = new Set();
    linksData.forEach(e => {
        const sid = typeof e.source === 'object' ? e.source.id : e.source;
        const tid = typeof e.target === 'object' ? e.target.id : e.target;
        if (sid === nodeId) connected.add(tid);
        if (tid === nodeId) connected.add(sid);
    });
    return connected;
}

function getConnectedEdges(nodeId) {
    const edges = [];
    linksData.forEach(e => {
        const sid = typeof e.source === 'object' ? e.source.id : e.source;
        const tid = typeof e.target === 'object' ? e.target.id : e.target;
        if (sid === nodeId) edges.push({entity: tid, weight: e.weight, docs: e.sample_docs || []});
        if (tid === nodeId) edges.push({entity: sid, weight: e.weight, docs: e.sample_docs || []});
    });
    return edges.sort((a,b) => b.weight - a.weight);
}

function showDetailPanel(d) {
    const panel = document.getElementById('detail-panel');
    const content = document.getElementById('dp-content');

    const typeColor = TYPE_COLORS[d.type] || '#666';
    const connections = getConnectedEdges(d.id);
    const datasets = DATA.top50_datasets[d.id];

    let html = `
        <div class="dp-name">${d.id}</div>
        <div class="dp-type" style="background:${typeColor}22;color:${typeColor};border:1px solid ${typeColor}">${d.type}</div>
        <div class="dp-stats">
            <div class="dp-stat"><div class="dp-val">${d.frequency}</div><div class="dp-lbl">Frequenza</div></div>
            <div class="dp-stat"><div class="dp-val">${d.pagerank.toFixed(5)}</div><div class="dp-lbl">PageRank</div></div>
            <div class="dp-stat"><div class="dp-val">${d.betweenness.toFixed(5)}</div><div class="dp-lbl">Betweenness</div></div>
            <div class="dp-stat"><div class="dp-val">${d.community}</div><div class="dp-lbl">Comunit&agrave;</div></div>
        </div>
    `;

    if (datasets) {
        html += '<div class="dp-section-title">Distribuzione Dataset</div>';
        Object.entries(datasets).sort((a,b) => b[1] - a[1]).forEach(([ds, cnt]) => {
            html += `<div class="dp-dataset"><span class="ds-name">${ds}</span><span class="ds-count">${cnt}</span></div>`;
        });
    }

    html += `<div class="dp-section-title">Connessioni (${connections.length})</div>`;
    const showConns = connections.slice(0, 30);
    showConns.forEach(c => {
        const cNode = nodeMap[c.entity];
        const cColor = cNode ? (TYPE_COLORS[cNode.type] || '#666') : '#666';
        html += `<div class="dp-connection" onclick="focusNode('${c.entity.replace(/'/g, "\\'")}')">
            <span class="conn-name" style="color:${cColor}">${c.entity}</span>
            <span class="conn-weight">w=${c.weight}</span>
        </div>`;
    });
    if (connections.length > 30) {
        html += `<div style="text-align:center;font-size:.75em;color:var(--dim);margin-top:6px;">+ altre ${connections.length - 30} connessioni</div>`;
    }

    content.innerHTML = html;
    panel.classList.add('active');
    document.getElementById('detail-backdrop').classList.add('active');
}

function focusNode(nodeId) {
    const node = nodesData.find(n => n.id === nodeId);
    if (node) {
        selectedNode = node;
        showDetailPanel(node);
        highlightNode(node);
    }
}

function closeDetail() {
    document.getElementById('detail-panel').classList.remove('active');
    document.getElementById('detail-backdrop').classList.remove('active');
    selectedNode = null;
    // Reset visuals
    if (searchTerm) {
        nodeElements
            .attr('opacity', d => d.id.toLowerCase().includes(searchTerm) ? 1 : 0.15)
            .attr('filter', d => d.id.toLowerCase().includes(searchTerm) ? 'url(#glow)' : null)
            .attr('stroke', 'rgba(255,255,255,.15)')
            .attr('stroke-width', 0.5);
        linkElements.attr('opacity', 1).attr('stroke', 'rgba(255,255,255,.08)')
            .attr('stroke-width', d => Math.max(0.3, Math.log(d.weight + 1) * 0.6));
        labelElements.attr('opacity', d => d.id.toLowerCase().includes(searchTerm) ? 1 : 0.1);
    } else {
        nodeElements.attr('opacity', 1).attr('filter', null).attr('stroke', 'rgba(255,255,255,.15)').attr('stroke-width', 0.5);
        linkElements.attr('opacity', 1).attr('stroke', 'rgba(255,255,255,.08)')
            .attr('stroke-width', d => Math.max(0.3, Math.log(d.weight + 1) * 0.6));
        labelElements.attr('opacity', 1);
    }
}

// Click on svg background to deselect
document.getElementById('graph-svg').addEventListener('click', function(e) {
    if (e.target === this || e.target.tagName === 'svg') {
        closeDetail();
    }
});

// ===== DRAG =====
function dragStart(event, d) {
    if (!event.active) simulation.alphaTarget(0.15).restart();
    d.fx = d.x; d.fy = d.y;
}
function dragging(event, d) {
    d.fx = event.x; d.fy = event.y;
}
function dragEnd(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null; d.fy = null;
}

// ===== CHART.JS CHARTS =====
function buildCharts() {
    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false },
        },
        scales: {
            x: {
                ticks: { color: '#777', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,.05)' }
            },
            y: {
                ticks: { color: '#ccc', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,.05)' }
            }
        }
    };

    // Frequency Chart
    const topFreq = DATA.stats.top_frequency.slice(0, 15);
    new Chart(document.getElementById('chart-freq'), {
        type: 'bar',
        data: {
            labels: topFreq.map(e => e.name),
            datasets: [{
                data: topFreq.map(e => e.freq),
                backgroundColor: topFreq.map(e => {
                    const node = nodeMap[e.name];
                    return node ? (TYPE_COLORS[node.type] || '#666') + '99' : '#e6394699';
                }),
                borderColor: topFreq.map(e => {
                    const node = nodeMap[e.name];
                    return node ? (TYPE_COLORS[node.type] || '#666') : '#e63946';
                }),
                borderWidth: 1,
                borderRadius: 3
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                ...chartDefaults.plugins,
                tooltip: {
                    callbacks: {
                        label: ctx => `Frequenza: ${ctx.raw}`
                    }
                }
            }
        }
    });

    // PageRank Chart
    const topPR = DATA.stats.top_pagerank.slice(0, 15);
    new Chart(document.getElementById('chart-pr'), {
        type: 'bar',
        data: {
            labels: topPR.map(e => e.name),
            datasets: [{
                data: topPR.map(e => e.score),
                backgroundColor: '#2a9d8f88',
                borderColor: '#2a9d8f',
                borderWidth: 1,
                borderRadius: 3
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                ...chartDefaults.plugins,
                tooltip: {
                    callbacks: {
                        label: ctx => `PageRank: ${ctx.raw.toFixed(6)}`
                    }
                }
            }
        }
    });

    // Betweenness Chart
    const topBtw = DATA.stats.top_betweenness.slice(0, 15);
    new Chart(document.getElementById('chart-btw'), {
        type: 'bar',
        data: {
            labels: topBtw.map(e => e.name),
            datasets: [{
                data: topBtw.map(e => e.score),
                backgroundColor: '#9b59b688',
                borderColor: '#9b59b6',
                borderWidth: 1,
                borderRadius: 3
            }]
        },
        options: {
            ...chartDefaults,
            indexAxis: 'y',
            plugins: {
                ...chartDefaults.plugins,
                tooltip: {
                    callbacks: {
                        label: ctx => `Betweenness: ${ctx.raw.toFixed(6)}`
                    }
                }
            }
        }
    });

    // Type Distribution Doughnut
    const typeDist = DATA.stats.type_distribution;
    const typeLabels = Object.keys(typeDist);
    const typeValues = Object.values(typeDist);
    const typeColors = typeLabels.map(t => TYPE_COLORS[t] || '#666');

    new Chart(document.getElementById('chart-types'), {
        type: 'doughnut',
        data: {
            labels: typeLabels,
            datasets: [{
                data: typeValues,
                backgroundColor: typeColors.map(c => c + 'cc'),
                borderColor: typeColors,
                borderWidth: 2,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '55%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ccc',
                        padding: 14,
                        font: { size: 11 },
                        usePointStyle: true,
                        pointStyleWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const total = typeValues.reduce((a,b) => a+b, 0);
                            const pct = ((ctx.raw / total) * 100).toFixed(1);
                            return ` ${ctx.label}: ${ctx.raw.toLocaleString('it-IT')} (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

// ===== COMMUNITY CARDS =====
function buildCommunities() {
    const grid = document.getElementById('comm-grid');
    const commKeys = Object.keys(DATA.communities).sort((a,b) => {
        return DATA.communities[b].count - DATA.communities[a].count;
    });

    commKeys.forEach(k => {
        const comm = DATA.communities[k];
        const color = COMMUNITY_COLORS[+k % COMMUNITY_COLORS.length];

        let entitiesHtml = '';
        comm.top_entities.forEach(e => {
            const node = nodeMap[e.name];
            const eColor = node ? TYPE_COLORS[node.type] || '#666' : '#999';
            entitiesHtml += `<span class="cc-entity" style="border-color:${eColor}40" onclick="focusNodeFromComm('${e.name.replace(/'/g, "\\'")}')">${e.name} <span class="ce-freq">(${e.freq})</span></span>`;
        });

        let typesHtml = '';
        if (comm.types) {
            Object.entries(comm.types).sort((a,b) => b[1] - a[1]).forEach(([t, n]) => {
                const tc = TYPE_COLORS[t] || '#666';
                typesHtml += `<span class="cc-type-badge" style="background:${tc}22;color:${tc};border:1px solid ${tc}55">${t}: ${n}</span>`;
            });
        }

        const card = document.createElement('div');
        card.className = 'comm-card';
        card.style.borderLeftColor = color;
        card.style.borderLeft = `4px solid ${color}`;
        card.innerHTML = `
            <div class="cc-header">
                <span class="cc-id" style="color:${color}">Comunit&agrave; ${k}</span>
                <span class="cc-count">${comm.count} entit&agrave;</span>
            </div>
            <div class="cc-entities">${entitiesHtml}</div>
            <div class="cc-types">${typesHtml}</div>
        `;
        grid.appendChild(card);
    });
}

function focusNodeFromComm(name) {
    // Set search to highlight the entity
    document.getElementById('search-input').value = name;
    searchTerm = name.toLowerCase();
    updateGraph();
    // Scroll to graph
    document.getElementById('graph-container').scrollIntoView({behavior: 'smooth', block: 'center'});
}

</script>
</body>
</html>
